#!/bin/bash

POOL="$1"
shift 1

export PATH=$HOME/.nix-profile/bin:$PATH

export RESTIC_PASSWORD_COMMAND="pass show Passwords/restic"

export B2_ACCOUNT_ID=${B2_ACCOUNT_ID:-$(pass show Passwords/backblaze-api-key)}
export B2_ACCOUNT_KEY=${B2_ACCOUNT_KEY:-$(pass show Passwords/backblaze-secret-key)}

function restic_it() {
    echo "========================================================================"
    echo "restic backup ${@:$#}"
    echo "========================================================================"

    if [[ "$1" == "--bucket" ]]; then
        bucket="$2"
        shift 2
    else
        bucket=$(echo ${@:$#} | sed 's%/%-%g')
    fi

    cat ~/.config/ignore.lst                    \
        | sed 's/^- //'                         \
        | sed 's%/$%/**%'                       \
        > /tmp/ignore.$$

    fs="${@:$#}"
    DIR=$(zfs get -H -o value mountpoint $POOL/$fs)

    restic                                      \
        --repo b2:jwiegley-${bucket} backup     \
	-o b2.connections=10                    \
        --ignore-inode                          \
        --one-file-system                       \
        --exclude-if-present '.b2-exclude'      \
        --exclude-file /tmp/ignore.$$           \
        "$DIR"
}

case ${1:---all} in
  --all)
    for i in                                    \
        Applications                            \
        Archives                                \
        Audio                                   \
        Backups/Images                          \
        Backups/Misc                            \
        Backups/Photos                          \
        Backups/Windows/BootCamp                \
        Backups/Windows/Data                    \
        Backups/Windows/Games                   \
        ChainState/cardano                      \
        ChainState/kadena/chainweb-data         \
        ChainState/kadena/chainweb-node         \
        Databases                               \
        Desktop                                 \
        Documents                               \
        Downloads                               \
        Home                                    \
        Library                                 \
        Machines                                \
        Media                                   \
        Messages                                \
        Movies                                  \
        Music                                   \
        Photos                                  \
        Pictures                                \
        Video                                   \
        doc                                     \
        kadena                                  \
        src
    do
        $0 $POOL $i
    done
    ;;

  Applications)
    echo "No backup set defined for $1" ;;

  Archives)
    echo "No backup set defined for $1" ;;

  Audio)
    restic_it Audio ;;

  Backups/Images)
    echo "No backup set defined for $1" ;;

  Backups/Misc)
    restic_it Backups/Misc ;;

  Backups/Photos)
    echo "No backup set defined for $1" ;;

  Backups/Windows/BootCamp)
    echo "No backup set defined for $1" ;;

  Backups/Windows/Data)
    echo "No backup set defined for $1" ;;

  Backups/Windows/Games)
    echo "No backup set defined for $1" ;;

  ChainState/cardano)
    echo "No backup set defined for $1" ;;

  ChainState/kadena/chainweb-data)
    echo "No backup set defined for $1" ;;

  ChainState/kadena/chainweb-node)
    echo "No backup set defined for $1" ;;

  Databases)
    restic_it Databases ;;

  Desktop)
    restic_it Desktop ;;

  Documents)
    restic_it Documents ;;

  Downloads)
    echo "No backup set defined for $1" ;;

  Home)
    restic_it                                           \
        --exclude '.Trash/**'                           \
        --exclude '.cabal/**'                           \
        --exclude '.cache/**'                           \
        --exclude '.cargo/**'                           \
        --exclude '.ghc/**'                             \
        --exclude '.hoogle/**'                          \
        --exclude '.slocdata/**'                        \
        --exclude '/.local/share/aria2c/aria2c.log'     \
        --exclude '/.local/share/vagrant/**'            \
        --exclude '/.local/share/recoll/xapiandb/**'    \
        Home ;;

  Library)
    restic_it                                                   \
        --exclude 'Application Support/Bookmap/Cache/**'        \
        --exclude 'Application Support/DEVONsphere Express/**'  \
        --exclude 'Application Support/DEVONthink Pro 2/**'     \
        --exclude 'Application Support/Dash/**'                 \
        --exclude 'Application Support/Path Finder/**'          \
        --exclude 'Application Support/PhoneView/**'            \
        --exclude 'Application Support/MobileSync/**'           \
        --exclude 'Containers/**'                               \
        --exclude 'Caches/GeoServices/**'                       \
        --exclude 'Logs/DiagnosticReports/dovecot-*.diag'       \
        --exclude 'Logs/DiagnosticReports/ledger_*.crash'       \
        --exclude 'Logs/DiagnosticReports/replica_*.crash'      \
        --exclude 'Logs/zoominstall.log'                        \
        Library ;;

  Machines)
    echo "No backup set defined for $1" ;;

  Media)
    restic_it                                   \
        --exclude 'Windows/Media/**'            \
        --exclude 'Windows/Templates/**'        \
        --exclude 'macOS/Media/**'              \
        --exclude 'macOS/Templates/**'          \
        --exclude 'Linux/CentOS/Media/**'       \
        --exclude 'Linux/Ubuntu/Media/**'       \
        Media ;;

  Messages)
    restic_it                                           \
        --exclude '/Mailboxes/lucene-indexes/**'        \
        --exclude 'dovecot.index.backup'                \
        --exclude 'dovecot.index.cache'                 \
        --exclude 'dovecot.index.log'                   \
        --exclude 'dovecot.index.log.*'                 \
        Messages ;;

  Movies)
    echo "No backup set defined for $1" ;;

  Music)
    echo "No backup set defined for $1" ;;

  Photos)
    # jww (2023-01-13): Waiting to finalize data set
    # restic_it Photos ;;
    echo "No backup set defined for $1" ;;

  Pictures)
    echo "No backup set defined for $1" ;;

  Video)
    # jww (2023-01-13): Due to historical accident, the bucket is called
    # jwiegley-Movies, and not jwiegley-Video; but since it's very large and I
    # cannot rename buckets, it's not worth re-uploading just yet. The usual
    # ~/Movies folder isn't something I backup to B2.
    restic_it                                   \
        --bucket Movies                         \
        --exclude 'Bicycle/**'                  \
        --exclude 'DSSS17/**'                   \
        --exclude 'OPLSS/**'                    \
        --exclude 'Introductory/**'             \
        --exclude 'Haskell/**'                  \
        --exclude 'Finance/**'                  \
        Video ;;

  doc)
    restic_it doc ;;

  kadena)
    echo "No backup set defined for $1" ;;

  src)
    restic_it                                   \
        --exclude 'nix/nixpkgs/**'              \
        --exclude 'MAlonzo/**'                  \
        src ;;

  *)
    echo "ERROR: Reached fall-through for $1"
    exit 1
    ;;
esac
