#!/bin/bash

POOL="$1"
shift 1

export PATH=$HOME/.nix-profile/bin:$PATH
export RESTIC_PASSWORD_COMMAND="pass show Passwords/restic"
export B2_ACCOUNT_ID=${B2_ACCOUNT_ID:-$(pass show Passwords/backblaze-api-key)}
export B2_ACCOUNT_KEY=${B2_ACCOUNT_KEY:-$(pass show Passwords/backblaze-secret-key)}

function restic_it() {
    echo "========================================================================"
    echo "restic backup ${@:$#}"
    echo "========================================================================"

    if [[ "$1" == "--bucket" ]]; then
        bucket="$2"
        shift 2
    else
        bucket=$(echo ${@:$#} | sed 's%/%-%g')
    fi

    cat ~/.config/ignore.lst                    \
        | sed 's/^- //'                         \
        | sed 's%/$%/**%'                       \
        > /tmp/ignore.$$

    fs="${@:$#}"
    DIR=$(zfs get -H -o value mountpoint $POOL/$fs)

    restic                                      \
        --limit-upload 1000                     \
        --repo b2:jwiegley-${bucket} backup     \
	-o b2.connections=10                    \
        --ignore-inode                          \
        --one-file-system                       \
        --exclude-if-present '.b2-exclude'      \
        --exclude-file /tmp/ignore.$$           \
        "${@:1:$#-1}"                           \
        "$DIR"
}

case ${1:---all} in
  --all)
    for i in                                    \
        Audio                                   \
        Backups/Misc                            \
        Databases                               \
        Desktop                                 \
        Documents                               \
        Home                                    \
        Library                                 \
        Media                                   \
        Messages                                \
        doc                                     \
        src
    do
        # jww (2023-02-02): Add these back once they complete manually:
        # Photos
        # Video
        $0 $POOL $i
    done
    ;;

  Home)
    restic_it                                           \
        --exclude '.cabal'                              \
        --exclude '.cargo'                              \
        --exclude '.ghc'                                \
        --exclude '.slocdata'                           \
        --exclude '.local/share/vagrant'                \
        Home ;;

  Library)
    restic_it                                                           \
        --exclude 'Application Support/Bookmap/Cache'                   \
        --exclude 'Application Support/FileProvider'                    \
        --exclude 'Application Support/PhoneView'                       \
        --exclude 'Application Support/MobileSync'                      \
        --exclude 'CloudStorage/GoogleDrive-copper2gold1@gmail.com'     \
        --exclude 'Containers'                                          \
        --exclude 'Caches/GeoServices'                                  \
        Library ;;

  Messages)
    restic_it                                   \
        --exclude 'lucene-indexes'              \
        --exclude 'dovecot.index.*'             \
        Messages ;;

  Video)
    # jww (2023-01-13): Due to historical accident, the bucket is called
    # jwiegley-Movies, and not jwiegley-Video; but since it's very large and I
    # cannot rename buckets, it's not worth re-uploading just yet. The usual
    # ~/Movies folder isn't something I backup to B2.
    restic_it --bucket Movies Video ;;

  *) restic_it $1 ;;
esac
