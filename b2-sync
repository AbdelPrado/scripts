#!/bin/bash

ARCHIVE=/Volumes/slim

function rclone_dirs() {
    echo rclone sync "$@"
    rclone sync -v                              \
        --retries 2                             \
        --fast-list                             \
        --transfers 4                           \
        --delete-excluded                       \
        --exclude '.DocumentRevisions-V100/**'  \
        --exclude '.Spotlight-V100/**'          \
        --exclude '.TemporaryItems/**'          \
        --exclude '.Trash/**'                   \
        --exclude '.Trashes/**'                 \
        --exclude '.Trashes'                    \
        --exclude '.apdisk'                     \
        --exclude '.fseventsd/**'               \
        --exclude '.zfs/**'                     \
        "$@"
}

function rclone_it() {
    rclone_dirs "$ARCHIVE/$1" crypt-${1}:
}

function b2_sync_dirs() {
    echo backblaze-b2 sync "$@"
    backblaze-b2 sync --keepDays 722 --replaceNewer     \
        --excludeRegex '.*\.DocumentRevisions-V100.*'   \
        --excludeRegex '.*\.Spotlight-V100.*'           \
        --excludeRegex '.*\.TemporaryItems.*'           \
        --excludeRegex '.*\.Trash.*'                    \
        --excludeRegex '.*\.apdisk'                     \
        --excludeRegex '.*\.fseventsd.*'                \
        --excludeRegex '.*\.zfs.*'                      \
        "$@"
}

function b2_sync_it() {
    b2_sync_dirs "$ARCHIVE/$1" b2://jwiegley-$1
}

case ${1:-all} in
  Documents) rclone_it Documents ;;
  Desktop)   rclone_it Desktop ;;

  Home)
    rclone_dirs \
        --exclude '.config/recoll/xapiandb/**' \
        "$ARCHIVE/Home"      "crypt-Backups-System-Home:" ;;
  Library)
    rclone_dirs --exclude 'Application Support/Path Finder/**' \
        --exclude 'Application Support/DEVONthink Pro 2/**' \
        --exclude 'Application Support/Dash/**' \
        "$ARCHIVE/Library"   "crypt-Backups-System-Library:" ;;

  Messages)
    rclone_dirs --exclude 'dovecot.index*' \
        "$ARCHIVE/Messages" "crypt-Messages:" ;;

  Databases) b2_sync_it Databases ;;
  Photos)    b2_sync_it Photos ;;
  Pictures)  b2_sync_it Pictures ;;
  Audio)     b2_sync_it Audio ;;
  Games)     b2_sync_it Games ;;
  Misc)      b2_sync_it Backups/Misc ;;
  Servers)   b2_sync_it Backups/Servers ;;

  src)
    b2_sync_dirs \
        --excludeRegex 'nix/nixpkgs/.*' \
        --excludeRegex '.*\.vo' \
        --excludeRegex '.*\.v.d' \
        --excludeRegex '.*\.aux' \
        --excludeRegex '.*\.glob' \
        "$ARCHIVE/src" b2://jwiegley-src ;;

  Media)
    b2_sync_dirs \
        --excludeRegex 'Linux/(CentOS|Ubuntu)/Media/.*' \
        "$ARCHIVE/Media" b2://jwiegley-Media ;;

  Movies)
    b2_sync_dirs \
        --excludeRegex '.*(DSSS17|OPLSS|Introductory).*' \
        "$ARCHIVE/Movies" b2://jwiegley-Movies ;;

  all)
    for i in      \
        Documents \
        Messages  \
        Desktop   \
        Home      \
        Library   \
        src       \
        Databases \
        Photos    \
        Pictures  \
        Audio     \
        Games     \
        Media
    do
        b2-sync $i
    done
    ;;
esac
