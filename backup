#!/bin/bash -x

set -euo pipefail
IFS=$'\n\t'

function local_snapshots() {
    snapshot daily $1
    snapshot day_of_week $1
    snapshot weekly $1
    snapshot monthly $1
    snapshot yearly $1
}

function remote_snapshots() {
    ssh $1 snapshot daily $2
    ssh $1 snapshot day_of_week $2
    ssh $1 snapshot weekly $2
    ssh $1 snapshot monthly $2
    ssh $1 snapshot yearly $2
}

reindex-mail
sudo update.locate

push hermes
push fin

if ssh hermes test -d /Volumes/vault/Backups; then
    ssh hermes push vault
fi

if test -d /Volumes/slim/src; then
    push slim
    local_snapshots slim
    b2-sync /Volumes/slim slim
fi

if ssh fin test -d /Volumes/tank/Backups; then
    push tank
    remote_snapshots fin tank
    ssh fin b2-sync /Volumes/tank tank
fi

update -a || echo "Completed updating repositories"

exec u update
