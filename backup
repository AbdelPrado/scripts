#!/bin/bash

exec 3>&1 4>&2
trap 'exec 2>&4 1>&3' 0 1 2 3
exec 1> ~/.backups/backup-201709231309.log 2>&1

pushme mybook
pushme hermes

sudo $HOME/bin/zfs-snapshot day_of_week mybook
sudo $HOME/bin/zfs-snapshot day_of_week backup

if [[ -d /Volumes/backup/Backups ]]; then
    volcopy -av --delete /Volumes/mybook/Backups/Misc/    /Volumes/backup/Backups/Misc/
    volcopy -av --delete /Volumes/mybook/Backups/Servers/ /Volumes/backup/Backups/Servers/
    volcopy -av --delete /Volumes/mybook/Databases/       /Volumes/backup/Databases/
    volcopy -av --delete /Volumes/mybook/Games/           /Volumes/backup/Games/
    volcopy -av --delete /Volumes/mybook/Machines/        /Volumes/backup/Machines/
    volcopy -av --delete /Volumes/mybook/Media/           /Volumes/backup/Media/
    volcopy -av --delete /Volumes/mybook/Nasim/           /Volumes/backup/Nasim/
    volcopy -av --delete /Volumes/mybook/Photos/          /Volumes/backup/Photos/
    volcopy -av --delete /Volumes/mybook/Rentals/         /Volumes/backup/Rentals/
fi

~/Messages/manage-mail/remove-all-dups

update-nix -a -p --leq -Q -j4 && push-nix

update -a

b2-sync 400

echo "Backup completed"
