#!/bin/bash -x

pushall

load-env-ghc784 start-hackage
diskutil unmount /Volumes/Hackage

rsync -av --delete --exclude='*.ddictateprofile4' --exclude=jw-etc/ \
      ~/Documents/ ~/Dropbox/Documents/
rsync -av --delete --delete-excluded --exclude=dist/ \
      ~/Projects/ ~/Dropbox/Projects/

#(syncall; syncall; syncall) &
(sudo cleanup -u; sudo cleanup -u; sudo cleanup -u) &
pushme &
nix-copy-closure --to hermes $(readlink -f ~/.nix-profile) &
nix-copy-closure --to maia $(readlink -f ~/.nix-profile) &
update -a &
wait

~/Messages/manage-mail/remove-all-dups

pushall
pushme hermes

echo "Backup completed successfully."
