#!/bin/bash

function monitor() {
    label="$1"
    shift 1
    echo "$label"
    date >> ~/Library/Logs/${label}.log
    /usr/bin/time "$@"                          \
        >> ~/Library/Logs/${label}.log 2>&1     \
        || echo "$label FAILED!"
}

if quickping $HERMES_ETHERNET; then
    monitor "push-hermes" push hermes
fi

if [[ -d /Volumes/tank/src/pushme ]]; then
    monitor "push-tank" push tank
    monitor "snapshots-tank" snapshots tank
    monitor "b2-restic" b2-restic /Volumes/tank tank
fi

monitor "reindex-mail" reindex-mail

# if [[ ! -d ~/.local/share/recoll/xapiandb ]]; then
#     mkdir -p ~/.local/share/recoll/xapiandb
# fi
# monitor "recollindex" recollindex -z

monitor "update-kadena" update ~/kadena
monitor "update-src"    update ~/src
monitor "update-doc"    update ~/doc

if quickping $HERMES_ETHERNET; then
    monitor "nix-update-sync" u vulcan update-sync
    monitor "travel-ready-all" u vulcan travel-ready-all
    monitor "nix-check-all" u vulcan check-all
else
    monitor "nix-update"      u vulcan update
    monitor "travel-ready"     u vulcan travel-ready
    monitor "nix-check"     u vulcan check
fi

monitor "gpg-refresh-keys" gpg --refresh-keys
