#!/bin/bash

monitor() {
    label="$1"
    shift 1
    echo "===== $label ====="
    echo "########################################################################" \
         >> ~/Library/Logs/${label}.log
    date >> ~/Library/Logs/${label}.log
    echo "########################################################################" \
         >> ~/Library/Logs/${label}.log
    /usr/bin/time "$@"                          \
        >> ~/Library/Logs/${label}.log 2>&1     \
        || echo "$label FAILED!"
}

# Make sure that all authentications have been loaded:

u vulcan pull
getpass 'sample.com'
(cd ~/src/emacs ; git ru)

# Now run the backup

monitor "reindex-mail" reindex-mail

# if [[ ! -d ~/.local/share/recoll/xapiandb ]]; then
#     mkdir -p ~/.local/share/recoll/xapiandb
# fi
# monitor "recollindex" recollindex -z

monitor "update-git" update ~/kadena ~/src ~/doc

if quickping $HERMES_ETHERNET; then
    monitor "push-hermes" push hermes &
fi

if quickping $ATHENA_ETHERNET; then
    monitor "push-athena" push athena

    monitor "rebuild-athena" ssh athena zsh -il -c "u athena rebuild" &
fi

monitor "nix-update" u vulcan update &

(cd ~/doc/tasks ; \
 monitor "gacopy-tasks-backblaze" git annex sync backblaze --content --all)
(cd ~/kadena/docs ; \
 monitor "gacopy-kadena-backblaze" git annex sync backblaze --content --all)
(cd ~/Archives ; \
 monitor "gacopy-Archives-backblaze" git annex sync backblaze --content --all)

if quickping $HERMES_ETHERNET && ssh hermes test -d /Volumes/tank/src/pushme ; then
# if [[ -d /Volumes/tank/src/pushme ]]; then
    monitor "push-tank" push tank

    (cd ~/doc/tasks ; \
     monitor "gacopy-tasks-tank" git annex sync tank --content --all)
    (cd ~/kadena/docs ; \
     monitor "gacopy-kadena-tank" git annex sync tank --content --all)
    (cd ~/Archives ; \
     monitor "gacopy-Archives-tank" git annex sync tank --content --all)

    monitor "snapshots-tank" ssh hermes sudo sanoid --cron --verbose

    monitor "syncoid-kadena" \
        ssh hermes syncoid -r --skip-parent athena:studio/ChainState/kadena \
                tank/ChainState/kadena

    monitor "workspace-update" ssh hermes workspace-update

    ssh hermes << EOF
       tmux new-session -t session1 -d
       tmux send-keys -t session1 "b2-restic tank --all" C-m
EOF
fi

(cd ~/doc/tasks ;   monitor "gacopy-tasks-sync" git annex sync)
(cd ~/kadena/docs ; monitor "gacopy-kadena-sync" git annex sync)
(cd ~/Archives ;    monitor "gacopy-Archives-sync" git annex sync)

wait
