#!/bin/bash

cp -p ~/.emacs.el ~/Library/Emacs

(cd ~/bin; git addremove; git commit -a -m changes)
(cd ~/doc; git addremove; git commit -a -m changes)

if [ -d /Volumes/Alpha ]; then
    backup-games
fi

ssh -t jw sudo chown -R johnw Backup &
ssh -t jw sudo chmod -R u+w Backup &

wait

~/bin/backup/backup "$@" vps &

for entry in ~/Archives/*; do
    if [ -d "$entry" ]; then
	base=$(basename "$entry")
	if [ "$base" = "Backups" -o \
	     "$base" = "Games" -o \
	     "$base" = "Inbox" ]; then
	    continue
	else
	    rsync -aHxyzOu --inplace --del --delete-excluded --ignore-errors "$@" \
		--exclude='*.iso' --exclude='*.winclone/' \
		--exclude='*vmwarevm*' --exclude='*VMWare.rar' \
		--exclude='Wikipedia.dtBase2/' \
		"$entry"/ jw:Backup/Archives/"$base"/ &
	    sleep 60
	fi
    fi
done

hdiutil attach ~/Archives/Backups/VPS.sparsebundle
sudo chmod -R u+w /Volumes/VPS
~/bin/backup/backup "$@" vps-snapshot

while [ -d /Volumes/VPS ]; do
    hdiutil detach /Volumes/VPS
    sleep 10
done

wait
