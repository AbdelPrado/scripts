#!/bin/bash

#CABAL=/usr/local/bin/cabal
CABAL=$HOME/.nix-profile/bin/cabal

if (( $# > 0 )); then
    cmd=$1
    shift 1

    if [[ $cmd == update ]]; then
        index=/Volumes/Hackage/00-index.tar.gz
        if [[ -f $index ]]; then
            echo Installing package database from local mirror...
            size=$(gzip -q -l $index | awk '{print $2}')
        else
            size=0
        fi

        echo Downloading package database from hackage.haskell.org...
        mkdir -p ~/.cabal/packages/hackage.haskell.org
        curl -s -o - http://hackage.haskell.org/packages/index.tar.gz   \
            | gzip -dc | pv -s $size                                    \
            > ~/.cabal/packages/hackage.haskell.org/00-index.tar

        if [[ -f $index ]]; then
            echo Installing package database from local mirror...
            mkdir -p ~/.cabal/packages/mirror
            gzip -dc $index | pv -s $size \
                > ~/.cabal/packages/mirror/00-index.tar
        fi
    elif [[ $cmd == install ]]; then
        exec $CABAL $cmd -j --enable-library-profiling              \
            --haddock-hoogle --haddock-html --haddock-executables   \
            --haddock-internal --haddock-hyperlink-source "$@"
    else
        exec $CABAL $cmd "$@"
    fi
else
    exec $CABAL
fi
