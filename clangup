#!/bin/bash

set -e

rebuild=false
nopull=false
notest=false

while getopts ":Cnb" opt; do
  case $opt in
    C)  rebuild=true ;;
    n)  nopull=true ;;
    T)  notest=true ;;
    \?) echo "Invalid option: -$OPTARG" >&2 ;;
  esac
done
shift $(($OPTIND - 1))

case $1 in
    upc)     ROOT=$HOME/Contracts/Intrepid/Projects/llvm ;;
    edg)     ROOT=$HOME/src/edg/ext/llvm ;;
    release) ROOT=/usr/local/src/llvm ;;
    trunk)   ROOT=$HOME/src/llvm ;;
    embt)    ROOT=$HOME/Contracts/Embarcadero/Projects/llvm ;;
    *)       ROOT=$HOME/Contracts/Embarcadero/Projects/branches/$1 ;;
esac

if [[ $nopull == false ]] && quickping bite.entic.net; then
    cd $ROOT && git pull
    (cd tools/clang && git pull)
    [[ -d tools/libcxx ]] && (cd tools/libcxx && git pull)
    [[ -d tools/libcxxabi ]] && (cd tools/libcxxabi && git pull)
    [[ -d test/Embt ]] && (cd test/Embt && git pull)
fi

case $1 in
    upc)     PRODUCTS=$HOME/Products/upc ;;
    edg)     PRODUCTS=$HOME/Products/edg/llvm ;;
    release) PRODUCTS=$HOME/Products/llvm-3.1 ;;
    trunk)   PRODUCTS=$HOME/Products/llvm ;;
    embt)    PRODUCTS=$HOME/Products/embt/main ;;
    *)       PRODUCTS=$HOME/Products/embt/$1 ;;
esac

[[ -d "$PRODUCTS" ]] || mkdir -p "$PRODUCTS"

cd "$PRODUCTS"

if [[ $rebuild == true || ! -f "$PRODUCTS/Makefile" ]]; then
    /bin/rm -fr *
    nice -n 20 cmake                                            \
        -DCMAKE_BUILD_TYPE:=Debug                               \
        -DLLVM_TARGETS_TO_BUILD:=X86                            \
        -DCMAKE_INSTALL_PREFIX:PATH=/usr/local/stow/clang       \
        $ROOT
fi

if ! nice -n 20 make-distcc; then
    echo "Clang failed to build"
    exit 1

elif [[ $notest == false ]] && ! nice -n 20 make clang-test; then
    echo "Clang failed tests"
    exit 2
fi

exit 0

### clangup ends here
