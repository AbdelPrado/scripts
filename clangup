#!/bin/bash

set -e

rebuild=true
if [[ "$1" == "-s" ]]; then
    rebuild=false
    shift 1
fi

nopull=false
if [[ "$1" == "-n" ]]; then
    nopull=true
    shift 1
fi

if [[ -n "$1" ]]; then
    ROOT=$HOME/Contracts/Embarcadero/Projects/branches/$1
else
    ROOT=$HOME/src/llvm
fi

if [[ $nopull == false ]]; then
    if quickping bite.entic.net; then
        cd $ROOT && git pull
        cd tools/clang && git pull
        if [[ -d test/Embt ]]; then
            cd test/Embt && git pull
        fi
    fi
fi

if [[ $(basename "$ROOT") == llvm ]]; then
    PRODUCTS=$HOME/Products/llvm/main
else
    PRODUCTS=$HOME/Products/llvm/$(basename "$ROOT")
fi
cd "$PRODUCTS"

if [[ $rebuild == true || ! -f "$PRODUCTS/Makefile" ]]; then
    /bin/rm -fr *
    nice -n 20 cmake -DCMAKE_BUILD_TYPE:=Debug -DLLVM_TARGETS_TO_BUILD:=X86 $ROOT
fi

if ! nice -n 20 make-distcc; then
    echo "Clang failed to build"
    exit 1
elif ! nice -n 20 make clang-test; then
    echo "Clang failed tests"
    exit 2
fi

exit 0

### clangup ends here
