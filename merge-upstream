#!/bin/bash

LOG=$HOME/Desktop/merge.log

set -o errexit

SOURCE=/Volumes/RAID/Mirrors/llvm
PRODUCTS=$HOME/Products/llvm-merge

update() {
    git remote update
    git checkout work
    git reset --hard HEAD
    git pull
    git merge origin/upstream
}

merge() {
    git checkout $1
    git merge $2
}

run() {
    cd $SOURCE;     "$@"
    cd tools/clang; "$@"
}    

echo Merging Clang/LLVM on $(date) > $LOG 2>&1

run update >> $LOG 2>&1

if [[ ! -d $PRODUCTS ]]; then
  mkdir -p $PRODUCTS
  cd $PRODUCTS
  $SOURCE/configure > /dev/null 
fi

cd $PRODUCTS
make -j16 | grep -v 'Nothing to be done for' >> $LOG 2>&1

# If it builds, push the commits to work now; it may not be passing tests
run git push >> $LOG 2>&1

cd $PRODUCTS/tools/clang/test
make -j16 >> $LOG 2>&1

# If it passes tests, merge it to next; it's ready to go to master when the
# time comes
run merge next work >> $LOG 2>&1
run merge master next >> $LOG 2>&1
run git push >> $LOG 2>&1

if egrep -q '(master -> master|Everything up-to-date)' $LOG; then
    mv $LOG $PRODUCTS
    exit 0
else
    exit 1
fi

