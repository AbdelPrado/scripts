on run theFiles

  -- check to see which iWork apps are running to begin with
  set powerpointRunning to false

  tell application "System Events"
    if exists process "Microsoft PowerPoint" then set powerpointRunning to true
  end tell

  set powerpointStarted to powerpointRunning

  repeat with aFile in theFiles

    -- prepare name manipulation
    set theInfo to (info for (aFile))
    set theExtension to name extension of (theInfo)
    set theName to name of (theInfo)
    set theOriginalName to theName

    -- remove extension
    set prevTIDs to AppleScript's text item delimiters
    set AppleScript's text item delimiters to "." & theExtension as string
    set theName to first text item of theName
    set AppleScript's text item delimiters to prevTIDs

    -- prepare desktop folder path and name
    set myDesktop to (path to desktop folder) as Unicode text
    set docPathAndName to myDesktop & theName & ".pdf"

    -- cases for conversions
    if (theExtension is equal to "ppt" or theExtension is equal to "pptx") then -- PowerPoint to PPT

      -- delete the file, if it exists, so it can be recreated
      tell application "Finder"
        if docPathAndName exists then delete docPathAndName
      end tell

      -- now make sure PowerPoint has the file open
      tell application "Microsoft PowerPoint"

        -- check if document is already open
        set targetDocument to null
        repeat with aDoc in presentations
          if (name of aDoc) is equal to theOriginalName then set targetDocument to aDoc
          activate targetDocument
        end repeat

        -- if not, open it
        if targetDocument is null then
          open aFile
          set fileOpened to true
          set targetDocument to front presentation

          save targetDocument in docPathAndName as save as PDF
        else
          set fileOpened to false
        end if

      end tell

      -- -- convert it, by GUI scripting
      -- tell application "System Events"
      --   tell process "Microsoft PowerPoint"
      --     set frontmost to true
      -- 
      --     click menu item "Save As…" of menu 1 of menu bar item "File" of menu bar 1
      -- 
      --     set theWindow to first window whose name is theName
      -- 
      --     repeat until button "Next…" of sheet 1 of theWindow exists
      --     end repeat
      -- 
      --     tell sheet 1 of theWindow
      --       click button "PDF" of tool bar 1
      --       -- click radio button "Slides" of radio group 1
      --       click radio button "Slides With Notes" of radio group 1
      --       if value of checkbox "Print each stage of builds" = 1 then
      --         click checkbox "Print each stage of builds"
      --       end if
      --       if value of checkbox "Include skipped slides" = 1 then
      --         click checkbox "Include skipped slides"
      --       end if
      --       if value of checkbox "Add borders around slides" = 1 then
      --         click checkbox "Add borders around slides"
      --       end if
      --       if value of checkbox "Include slide numbers" = 1 then
      --         click checkbox "Include slide numbers"
      --       end if
      --       if value of checkbox "Include date" = 1 then
      --         click checkbox "Include date"
      --       end if
      --       click button "Next…"
      --     end tell
      -- 
      --     repeat until button "Export" of sheet 1 of window theName exists
      --     end repeat
      -- 
      --     tell sheet 1 of theWindow
      --       -- switch to desktop folder
      --       keystroke "d" using command down
      -- 
      --       click button "Export"
      --     end tell
      -- 
      --     delay 1
      --     repeat while button "Cancel" of window 1 exists
      --       delay 1
      --     end repeat
      --     delay 1
      -- 
      --   end tell
      -- end tell

      tell application "Microsoft PowerPoint"

        -- close document if necessary
        if fileOpened then close targetDocument saving no

      end tell
      set powerpointStarted to true

    end if

  end repeat

  -- close any apps that were not open to begin with
  if powerpointStarted and not powerpointRunning then tell application "Microsoft PowerPoint" to quit

end run
