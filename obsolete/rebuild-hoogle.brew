#!/bin/bash -xe

HDIR=/usr/local/tools/hoogle/cabal-dev/share/x86_64-osx-ghc-7.6.3/hoogle-4.2.28/databases

test -d $HDIR || mkdir -p $HDIR
cd $HDIR

export PATH=/usr/local/tools/hoogle/cabal-dev/bin/:$PATH

function import_dbs() {
    find $1 -name '*.txt' \
        | parallel 'cp -p {} .; perl -i -pe "print \"\@url file://{//}/index.html\n\" if /^\@version/;" {/}; hoogle convert {/}'
}

import_dbs /usr/local/stow/ghc/share/doc/ghc/html/libraries
import_dbs /usr/local/stow/ghc/var/ghc/dot-cabal/share/doc

rm -f default.hoo rehoo*

time hoogle data --redownload -l $(echo *.txt | sed 's/\.txt//g')
time rehoo -j4 -c64 .
