#!/bin/bash

COMMENT="Snapshot $(date +'%Y-%m-%d %H:%M:%S')"

function push() {
    if [[ -d _darcs ]]; then
	project=$(basename $(pwd))
	if [[ $project == ledger ]]; then
	    project=cl-ledger
	fi
	darcs push --all jw:/srv/darcs/$project
    fi

    if [[ -d .hg || -d .svn ]]; then
	if [[ -d .hg ]]; then
	    hg push
	fi
	if [[ -d .svn ]]; then
	    svn commit -m "$*"
	fi
    elif pwd | grep -q CEG; then
	svk push --verbatim "$@"
    fi
}

function commit() {
    if [[ -d _darcs ]]; then
	darcs record -m "$*" --all --skip-long-comment
    fi

    if [[ -d .hg || -d .svn ]]; then
	if [[ -d .hg ]]; then
	    hg commit -m "$*"
	fi
    elif pwd | grep -q CEG; then
	svk commit -m "$*"
    fi
}

case $(basename $0) in
    commit)
	if [[ -z "$1" ]]; then
	    commit "$COMMENT"
	else
	    commit "$@"
	fi
	;;

    push)
	if [[ -z "$1" ]]; then
	    commit "$COMMENT"
	    push "$COMMENT"
	else
	    commit "$@"
	    push "$@"
	fi
	;;

    snapshot)
	echo Committing in ~/bin ...
	(cd ~/bin; commit "$COMMENT")
	echo Committing in ~/Documents ...
	(cd ~/Documents; commit "$COMMENT")
	echo Committing in ~/Library/Emacs ...
	(cd ~/Library/Emacs; commit "$COMMENT")

	for dir in ~/Projects/*/.hg; do
	    SRCDIR=$(dirname "$dir")
	    echo Committing in $SRCDIR ...
	    (cd "$SRCDIR"; commit "$COMMENT")
	done
	;;
esac

