#!/bin/bash

serial=false
fullsync=true
while getopts 'LNnvDQSsFfcj:h' opt; do
    case $opt in
        N)  OPTS="$OPTS -N" ;;
        c)  OPTS="$OPTS -c $OPTARG" ;;
        f)  OPTS="$OPTS -f $OPTARG" ;;
        s)  OPTS="$OPTS -c sync" ;;
        Q)  OPTS="$OPTS -c quick" ;;
        S)  serial=true ;;
        F)  fullsync=false ;;
        j)  OPTS="$OPTS -j$OPTARG" ;;
        h)  OPTS="$OPTS --from $OPTARG" ;;
        n)  OPTS="$OPTS -n" ;;
        v)  OPTS="$OPTS -v" ;;
        D)  OPTS="$OPTS -D" ;;
        \?) OPTS="$OPTS -$OPTARG" ;;
    esac
done
shift $(($OPTIND - 1))

if [[ -z "$1" ]]; then
    # if ! running postfix/master; then
    #     echo "Giving queued messages a chance to escape..."

    #     if sudo /usr/libexec/postfix/master -t; then
    #         sudo /usr/libexec/postfix/master -e 60 &
    #     fi
    #     sudo /usr/sbin/postqueue -f
    # fi

    find ~/Messages/Gnus -name 'nnir:*' -exec /bin/rm -fr '{}' \;

    find ~/src/ \( -name dist -o -path '*/cabal-dev/doc' \) -type d   \
        \! -path '*/shm/dist' \! -path '*/pushme/dist' -print0        \
        | xargs -0 /bin/rm -fr

    if quickping 192.168.9.133; then
        rsync -avz titan:/home/johnw/.znc/users/johnw/moddata/log/ \
              ~/Messages/znc/
        # find ~/Messages/znc -print0 | xargs -0 touch
    fi

    killall hdevtools

    find ~/Contracts/ ~/Projects/ -xdev                             \
        \( -name '.hdevtools.sock' -o -name '*_stub.*' \) -delete

    for repo in ~/bin ~/doc ~/Messages; do
        (cd $repo;                                      \
            sudo chown -R johnw .;                      \
            git addremove && git annex sync)            \
    done

    test -d /Volumes/Files   && diskutil eject /Volumes/Files
    test -d /Volumes/Hackage && diskutil eject /Volumes/Hackage
fi

#find-env > /tmp/env
#source /tmp/env
#rm -f /tmp/env
#
#if [[ -z "$1" ]]; then
#    if [[ $found = false ]]; then
#        echo "Could not find remote!"
#        exit 1
#    elif ! ssh $REMOTE true; then
#        echo "Error: Could not reach host $REMOTE"
#        exit 1
#    fi
#
#    echo "Remote is named $REMOTE"
#else
#    REMOTE=""
#fi

if [[ "$1" == vulcan || (-n "$REMOTE" && ($REMOTE == vulcan || $REMOTE == home)) ]]; then
    ARGS="$ARGS $REMOTE"
    OPTS="$OPTS -j4"
    if [[ $fullsync == false ]]; then
        OPTS="$OPTS -c sync"
    fi

elif [[ "$1" == hermes || (-n "$REMOTE" && ($REMOTE == hermes || $REMOTE == hermesw)) ]]; then
    ARGS="$ARGS $REMOTE"
    OPTS="$OPTS -j4"
    if [[ $fullsync == false ]]; then
        OPTS="$OPTS -c sync"
    fi

elif [[ "$1" == vault ]]; then
    OPTS="$OPTS -j4"

fi

PUSHME=$HOME/.nix-profile/bin/pushme
#PUSHME=$HOME/src/pushme/dist/build/pushme/pushme

$PUSHME --si --ssh="ssh -A -F $HOME/.ssh/config" $OPTS $ARGS "$@"

### pushme ends here
