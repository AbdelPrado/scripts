#!/bin/bash

OPTS="-L"
serial=false
while getopts 'LNnvQSj:' opt; do
    case $opt in
        N)  OPTS="$OPTS -N" ;;
        Q)  OPTS="$OPTS -c quick" ;;
        S)  serial=true ;;
        j)  OPTS="$OPTS -j$OPTARG" ;;
        n)  OPTS="$OPTS -n" ;;
        v)  OPTS="$OPTS -v" ;;
        \?) OPTS="$OPTS -$OPTARG" ;;
    esac
done
shift $(($OPTIND - 1))

# Find out which remote machine to copy to
if [[ -z "$1" ]]; then
    find-env > /tmp/env
    source /tmp/env
    rm -f /tmp/env

    if [[ $found = false ]]; then
        echo "Could not find remote!"
        exit 1
    elif ! ssh $REMOTE true; then
        echo "Error: Could not reach host $REMOTE"
        exit 1
    fi

    echo "Remote is named $REMOTE"
else
    REMOTE=""
fi

if [[ -z "$1" ]]; then
    if [[ -n "$REMOTE" && ($REMOTE == hermes || $REMOTE == hermesw) ]]; then
        sudo doveadm stop
    fi

    # Scan for items which should be synchronized
    if ! running postfix/master; then
        echo "Giving queued messages a chance to escape..."

        if sudo /usr/libexec/postfix/master -t; then
            sudo /usr/libexec/postfix/master -e 60 &
        fi
        sudo /usr/sbin/postqueue -f
    fi

    # Stop running applications
    #ssh $REMOTE osascript -e "tell application \"LaunchBar\" to quit"

    find ~/Messages/Gnus -name 'nnir:*' -exec /bin/rm -fr '{}' \;

    find ~/src/ \( -name dist                               \
        -o -path '*/cabal-dev/doc' \) -type d       \
        \! -path '*/pushme/dist' -print0            \
        | xargs -0 /bin/rm -fr

    # Synchronize directories
    if quickping 192.168.9.135; then
        rsync -avz nu:/home/johnw/.znc/users/johnw/moddata/log/ ~/Messages/znc/
    fi

    killall hdevtools

    find ~/Contracts/ ~/Projects/ -xdev                             \
        \( -name '*_flymake*'      -o -name 'flycheck-*'            \
        -o -name '.hdevtools.sock' -o -name '*_stub.*' \) -delete

    cd ~/.emacs.d/logs
    sudo git addremove
    sudo git commit -a -m Checkpoint

    cd ~/bin
    sudo git addremove
    sudo git commit -a -m Checkpoint

    cd ~/doc
    sudo git addremove
    sudo git commit -a -m Checkpoint
fi

if [[ -n "$REMOTE" && ($REMOTE == vulcan || $REMOTE == home) ]]; then
    OPTS="$OPTS -j4"

    if [[ -f /Volumes/tidbit/Data/Documents/Tasks/todo.txt ]]; then
        ARGS="tidbit"
    fi
    ARGS="$ARGS $REMOTE"

elif [[ -n "$REMOTE" && ($REMOTE == hermes || $REMOTE == hermesw) ]]; then
    OPTS="$OPTS -j4"

    rsync -av \
        hermes:'Applications/World\ of\ Warcraft/WTF/Account/78475252\#2/' \
        ~/Applications/World\ of\ Warcraft/WTF/Account/78475252\#2/

    if [[ -f /Volumes/tidbit/Data/Documents/Tasks/todo.txt ]]; then
        ARGS="tidbit"
    fi
    ARGS="$ARGS $REMOTE"

elif [[ "$1" == titan ]]; then
    ARGS="$ARGS titan mirror @mirror mirror/titan @tank tank/titan"
fi

time ~/src/pushme/dist/build/pushme/pushme                              \
    --ssh="ssh -F $HOME/.ssh/config" $OPTS $ARGS "$@"                   \
    && ( cd ~/.pushme && git commit --all -m "Updated on $(date)" )

if [[ -n "$REMOTE" ]]; then
    rsync -av --delete ~/.pushme/ $REMOTE:.pushme/

    if [[ $REMOTE == hermes || $REMOTE == hermesw ]]; then
        sudo dovecot
    fi
fi

exit 0

### pushme ends here
