#!/bin/bash

RSYNC='sudo /opt/local/bin/rsync'
FLAGS="-arPXHEyzh"
HOST=hermes

EXCLUDES=""
EXCLUDES="$EXCLUDES --exclude=/.com.apple.timemachine.supported"
EXCLUDES="$EXCLUDES --exclude=/.fseventsd/"
EXCLUDES="$EXCLUDES --exclude=/.Spotlight-V100/"
EXCLUDES="$EXCLUDES --exclude=/.TemporaryItems/"
EXCLUDES="$EXCLUDES --exclude=/.Trashes/"
EXCLUDES="$EXCLUDES --exclude=.DS_Store"
EXCLUDES="$EXCLUDES --exclude=.localized"
FLAGS="$FLAGS $EXCLUDES"

if [[ $(basename "$0") == 'pushme' ]]; then
    SOURCE=''
    TARGET="$HOST:"
    SSOURCE="$SOURCE$HOME"
    TTARGET="$TARGET/Volumes/Passport"
    CSOURCE="$SOURCE$HOME/Contracts"
    CTARGET="$TARGET/Volumes"
else
    SOURCE="$HOST:"
    TARGET=''
    SSOURCE="$SOURCE/Volumes/Passport"
    TTARGET="$TARGET$HOME"
    CSOURCE="$SOURCE/Volumes"
    CTARGET="$TARGET$HOME/Contracts"
fi

if ! ssh $HOST true; then
    exit 1
fi

echo $SOURCE$HOME/ '->' $TARGET$HOME/
rsync $FLAGS --delete --rsync-path "$RSYNC" \
    --include='/.Deskzilla/' \
    --include='/.MacOSX/' \
    --include='/.PySolFC/' \
    --include='/.bazaar/' \
    --include='/.datastudio/' \
    --include='/.dbvis/' \
    --include='/.deltawalker/' \
    --include='/.emacs.bmk' \
    --include='/.eshell/' \
    --include='/.filezilla/' \
    --include='/.gdbrc' \
    --include='/.git*' \
    --include='/.gnupg/' \
    --include='/.groovy/' \
    --include='/.inputrc' \
    --include='/.ledgerrc' \
    --include='/.m2/' \
    --include='/.scapy_startup.py' \
    --include='/.screenrc' \
    --include='/.ssh/' \
    --include='/.stella/' \
    --include='/.subversion/' \
    --include='/.vplls/' \
    --include='/.zshrc' \
    --include='/Desktop/' \
    --include='/Library/' \
    --include='/Music/' \
    --exclude='/*/' \
    --exclude='/*' \
    --exclude='/.*/' \
    --exclude='/.*' \
    --include='/Library/Application Support/' \
    --include='/Library/Audio/' \
    --include='/Library/Calendars/' \
    --include='/Library/Emacs/' \
    --include='/Library/FontCollections/' \
    --include='/Library/Fonts/' \
    --include='/Library/Info/' \
    --include='/Library/Inform/' \
    --include='/Library/Java/' \
    --include='/Library/KeyBindings/' \
    --include='/Library/Keyboard Layouts/' \
    --include='/Library/Lisp/' \
    --include='/Library/Mail/' \
    --include='/Library/Mail Downloads/' \
    --include='/Library/PreferencePanes/' \
    --include='/Library/Preferences/' \
    --include='/Library/QuicKeys/' \
    --include='/Library/QuickLook/' \
    --include='/Library/Scripts/' \
    --include='/Library/Sounds/' \
    --include='/Library/Spelling/' \
    --include='/Library/TexPackages/' \
    --include='/Library/Wallpapers/' \
    --include='/Library/Widgets/' \
    --include='/Library/Workflows/' \
    --include='/Library/Workflows/' \
    --include='/Library/XMind/' \
    --include='/Library/texmf/' \
    --exclude='/Library/*/' \
    --exclude='/Library/*' \
    --exclude='/Library/.*/' \
    --exclude='/Library/.*' \
    --include='/Library/Application Support/AddressBook/' \
    --include='/Library/Application Support/Adium 2.0/' \
    --include='/Library/Application Support/Colloquy/' \
    --include='/Library/Application Support/Cyberduck/' \
    --include='/Library/Application Support/DEVONagent/' \
    --include='/Library/Application Support/DEVONthink Pro 2/' \
    --include='/Library/Application Support/DVD Player/' \
    --include='/Library/Application Support/ecto3/' \
    --include='/Library/Application Support/Firefox/' \
    --include='/Library/Application Support/Google Earth/' \
    --include='/Library/Application Support/Hazel/' \
    --include='/Library/Application Support/IntelliJIDEA70/' \
    --include='/Library/Application Support/IntelliJIDEA80/' \
    --include='/Library/Application Support/Merlin/' \
    --include='/Library/Application Support/OmniGraffle/' \
    --include='/Library/Application Support/Scrivener/' \
    --include='/Library/Application Support/Skype/' \
    --include='/Library/Application Support/TextExpander/' \
    --include='/Library/Application Support/TextMate/' \
    --include='/Library/Application Support/Tunnelblick/' \
    --include='/Library/Application Support/WorldOfGoo/' \
    --exclude='/Library/Application Support/*/' \
    --exclude='/Library/Application Support/*' \
    --exclude='/Library/Application Support/.*/' \
    --exclude='/Library/Application Support/.*' \
    --include='/Library/Preferences/Adobe*/' \
    --include='/Library/Preferences/Adobe*' \
    --exclude='/Library/Preferences/*/' \
    --exclude='/Library/Preferences/*' \
    --exclude='/Library/Preferences/.*/' \
    --exclude='/Library/Preferences/.*' \
    $SOURCE$HOME/ $TARGET$HOME/

# these must be iterated, as some are symbolic links
for path in Documents Projects Sites
do
    echo $SOURCE$HOME/$path/ '->' $TARGET$HOME/$path/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	$SOURCE$HOME/$path/ $TARGET$HOME/$path/
done

if [[ -n "$1" ]]; then
    for contract in "$@"
    do
	echo $CSOURCE/$contract/ '->' $CTARGET/$contract/
	rsync $FLAGS --delete --rsync-path "$RSYNC" \
	    --exclude='Backup/' \
	    --exclude='Backup.[0-9]/' \
	    --exclude=/.backups/ \
	    --exclude=/Machines/ \
	    --exclude=/3dex/ \
	    --exclude=target/ \
	    --exclude=darwin/ \
	    $CSOURCE/$contract/ $CTARGET/$contract/
    done
fi

if [[ $(basename "$0") == 'pullyou' ]]; then
    # Downloads
    echo $SOURCE$HOME/Downloads/ '->' $TARGET$HOME/Downloads/
    rsync $FLAGS --rsync-path "$RSYNC" \
	$SOURCE$HOME/Downloads/ $TARGET$HOME/Downloads/

else
    ## Applications
    echo $SOURCE/Applications/ '->' $TARGET/Applications/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	--include='/Games/' \
	--include='/Misc/' \
	--exclude=/*/ \
	$SOURCE/Applications/ $TARGET/Applications/

    # opt
    echo $SOURCE/opt/local/var/macports/ '->' $TARGET/opt/local/var/macports/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	--exclude=.tclpackage \
	--exclude=/build/ \
	--exclude=/port-help.tcl \
	--exclude=/receipts/ \
	--exclude=/software/ \
	--exclude=/sources/ \
	$SOURCE/opt/local/var/macports/ $TARGET/opt/local/var/macports/
fi

# stow
echo $SOURCE/usr/local/stow/ '->' $TARGET/usr/local/stow/
rsync $FLAGS --delete --rsync-path "$RSYNC" \
    $SOURCE/usr/local/stow/ $TARGET/usr/local/stow/

# Archives
echo $SOURCE$HOME/Archives/ '->' $TARGET$HOME/Archives/
rsync $FLAGS --delete --rsync-path "$RSYNC" \
    --exclude='Backup/' \
    --exclude='Backup.[0-9]/' \
    --exclude=/Contracts/ \
    --exclude=/Games/ \
    --exclude=/Games \
    --exclude=/Linux/ \
    --exclude=/Linux \
    --exclude=/Systems/ \
    --exclude=/Systems \
    --exclude=/SICP/ \
    --exclude=/SICP \
    $SOURCE$HOME/Archives/ $TARGET$HOME/Archives/

if ssh $HOST test -d /Volumes/Passport; then
    # Archives, the larger part
    echo $SSOURCE/Archives/ '->' $TTARGET/Archives/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	--include=/Linux/ \
	--exclude=/Linux/Fedora/ \
	--exclude=/Linux/Debian/ \
	--exclude=/*/ \
	$SSOURCE/Archives/ $TTARGET/Archives/

    # Pictures
    echo /Volumes/RAID/Media/ '->' $TTARGET/Media/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	/Volumes/RAID/Media/ $TTARGET/Media/
fi

exit 0
