#!/bin/bash

RSYNC='sudo /opt/local/bin/rsync'
FLAGS="$* -arPXHEyzh"
HOST=hermes
#HOST=vulcan

EXCLUDES=""
EXCLUDES="$EXCLUDES --exclude=/.com.apple.timemachine.supported"
EXCLUDES="$EXCLUDES --exclude=/.fseventsd/"
EXCLUDES="$EXCLUDES --exclude=/.Spotlight-V100/"
EXCLUDES="$EXCLUDES --exclude=/.TemporaryItems/"
EXCLUDES="$EXCLUDES --exclude=/.Trashes/"
EXCLUDES="$EXCLUDES --exclude=.DS_Store"
EXCLUDES="$EXCLUDES --exclude=.localized"
FLAGS="$FLAGS $EXCLUDES"

if [[ $(basename "$0") == 'pushme' ]]; then
    SOURCE=''
    TARGET="$HOST:"
    SSOURCE="$SOURCE$HOME"
    TTARGET="$TARGET/Volumes/Passport"
    CSOURCE="$SOURCE$HOME/Contracts"
    CTARGET="$TARGET/Volumes"
else
    SOURCE="$HOST:"
    TARGET=''
    SSOURCE="$SOURCE/Volumes/Passport"
    TTARGET="$TARGET$HOME"
    CSOURCE="$SOURCE/Volumes"
    CTARGET="$TARGET$HOME/Contracts"
fi

if ! ssh $HOST true; then
    exit 1
fi

for contract in CEG TI; do
    echo $CSOURCE/$contract/ '->' $CTARGET/$contract/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	--exclude=/.backups/ \
	--exclude=/Machines/ \
	--exclude=/3dex/ \
	--exclude=target/ \
	--exclude=darwin/ \
	$CSOURCE/$contract/ $CTARGET/$contract/
done

for path in \
    Desktop Documents Projects Public Sites \
    Library/Emacs \
    Library/Lisp \
    Library/Scripts \
    Library/QuicKeys \
    Music
do
    echo $SOURCE$HOME/$path/ '->' $TARGET$HOME/$path/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	$SOURCE$HOME/$path/ $TARGET$HOME/$path/
done

if [[ $(basename "$0") == 'pullyou' ]]; then
    # Downloads
    echo $SOURCE$HOME/Downloads/ '->' $TARGET$HOME/Downloads/
    rsync $FLAGS --rsync-path "$RSYNC" \
	$SOURCE$HOME/Downloads/ $TARGET$HOME/Downloads/
fi

## Applications
#echo $SOURCE/Applications/ '->' $TARGET/Applications/
#rsync $FLAGS --delete --rsync-path "$RSYNC" \
#    --include='/Games/' \
#    --include='/Misc/' \
#    --exclude=/*/ \
#    $SOURCE/Applications/ $TARGET/Applications/

# opt
echo $SOURCE/opt/local/var/macports/ '->' $TARGET/opt/local/var/macports/
rsync $FLAGS --delete --rsync-path "$RSYNC" \
    --exclude=.tclpackage \
    --exclude=/build/ \
    --exclude=/port-help.tcl \
    --exclude=/receipts/ \
    --exclude=/software/ \
    --exclude=/sources/ \
    $SOURCE/opt/local/var/macports/ $TARGET/opt/local/var/macports/

# stow
echo $SOURCE/usr/local/stow/ '->' $TARGET/usr/local/stow/
rsync $FLAGS --delete --rsync-path "$RSYNC" \
    $SOURCE/usr/local/stow/ $TARGET/usr/local/stow/

# Archives
echo $SOURCE$HOME/Archives/ '->' $TARGET$HOME/Archives/
rsync $FLAGS --delete --rsync-path "$RSYNC" \
    --exclude=/Contracts/ \
    --exclude=/Backups/ \
    --exclude=/Backups \
    --exclude=/Games/ \
    --exclude=/Games \
    --exclude=/Linux/ \
    --exclude=/Linux \
    --exclude='/Mac OS X/' \
    --exclude='/Mac OS X' \
    --exclude=/Systems/ \
    --exclude=/Systems \
    --exclude=/Windows/ \
    --exclude=/Windows \
    --exclude=/SICP/ \
    --exclude=/SICP \
    $SOURCE$HOME/Archives/ $TARGET$HOME/Archives/

if ssh $HOST test -d /Volumes/Passport; then
    # Archives, the larger part
    echo $SSOURCE/Archives/ '->' $TTARGET/Archives/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	--include=/Backups/ \
	--include=/Linux/ \
	--exclude=/Linux/Fedora/ \
	--exclude=/Linux/Debian/ \
	--include='/Mac OS X/' \
	--include=/Windows/ \
	--exclude=/*/ \
	$SSOURCE/Archives/ $TTARGET/Archives/

    # Pictures
    echo $SOURCE$HOME/Pictures/ '->' $TARGET$HOME/Pictures/
    rsync $FLAGS --delete --rsync-path "$RSYNC" \
	$SOURCE$HOME/Pictures/ $TARGET$HOME/Pictures/
fi
