#!/bin/zsh

VOLCOPY=$HOME/bin/volcopy
OPTS="-Hhv --ignore-errors --delete --force-delete --exclude=.remove.lst"
QUICK=false

if [[ "$1" == "--quick" ]]; then
    QUICK=true
    shift 1
fi

echo '==================================================================='
echo "Backing up $HOME to Titan"
echo '==================================================================='

sudo su - root -c "$VOLCOPY $* $OPTS --delete --filter='-p .#*' \
    --exclude=/.screenrc --exclude=/.local/ --exclude=/.cache/ \
    --exclude=/.cabal/lib/ --exclude=/.cabal/packages/ \
    --exclude=/.cabal/share/ --exclude=/.cabal/logs/ \
    --exclude='/Library/Application Support/Hazel/trash*' \
    --exclude=/Library/Caches/ \
    --exclude=/Documents/ \
    --exclude=/Messages/ \
    --exclude=/Projects/ \
    /Users/johnw/ root@titan:\~johnw/"

#if [[ $QUICK == false ]]; then
#    echo '==================================================================='
#    echo "Archiving .cabal and Messages"
#    echo '==================================================================='
#
#    (cd ~ ; tar cf ~/Archives/Stow/mycabal.tar .cabal .ghc) &
#    (cd ~ ; tar cf ~/Archives/Messages.tar Messages) &
#
#    wait
#
#    echo '==================================================================='
#    echo "Compressing .cabal and Messages"
#    echo '==================================================================='
#
#    rm -f ~/Archives/Stow/mycabal.tar.xz
#    pxz -v ~/Archives/Stow/mycabal.tar &
#
#    rm -f ~/Archives/Messages.tar.xz
#    pxz -v ~/Archives/Messages.tar &
#
#    wait
#fi

for dir in ~/* /Volumes/Data/*
do
    if [[ -h "$dir" || ! -d "$dir" ]]; then
        continue
    elif [[ "$dir" == "/Users/johnw/Music" \
         || "$dir" == "/Users/johnw/Movies" \
         || "$dir" == "/Volumes/Data/Messages" \
         || "$dir" == "/Volumes/Data/Movies" \
         || "$dir" == "/Volumes/Data/Backups" ]]; then
        continue
    fi
    cd "$dir"

    dir=$(basename "$dir")
    if ! ssh johnw@titan test -d "/data/$dir"; then
        continue
    fi

    echo '==================================================================='
    echo "Backing up $dir to Titan"
    echo '==================================================================='

    rm -f .remove.lst
    /usr/bin/find . \
        \! \( -name .Trashes -prune \) \
        \! \( -name .TemporaryItems -prune \) \
        \! -name .DS_Store \! -name .localized \
        \! -name .exclude.lst -flags hidden >> .remove.lst

     if [[ -f .exclude.lst ]]; then
         sudo su - root -c "$VOLCOPY $* $OPTS --exclude-from=$PWD/.exclude.lst \
             $PWD/ root@titan:'/data/$dir/'"
     else
         sudo su - root -c "$VOLCOPY $* $OPTS $PWD/ root@titan:'/data/$dir/'"
     fi

     if [[ -f .remove.lst ]]; then
         cat .remove.lst | while read pathname; do
             rm -fr "$pathname"
             expathname=$(echo $pathname | sed 's/^\.//')
             echo "- $expathname" >> .exclude.lst
         done
         rm -f .remove.lst
     fi

     if [[ -f .exclude.lst ]]; then
         uniqify .exclude.lst
         sudo su - root -c "scp -qp $PWD/.exclude.lst johnw@titan:'/data/$dir'"
     fi
done
