#!/bin/bash

OPTS="-Hhv --ignore-errors --delete --force-delete --exclude=.remove.lst"

volcopy "$@" $OPTS --delete --filter='-p .#*' \
    --exclude=/.screenrc --exclude=/.local/ --exclude=/.cache/ \
    --exclude='/Library/Application Support/Hazel/trash*' \
    --exclude=/Library/Caches/ \
    --exclude=/Documents/ \
    --exclude=/Messages/ \
    --exclude=/Projects/ \
    ~/ johnw@titan:./

#osascript -e 'tell application "VMware Fusion" to quit'
#sleep 300

for dir in ~/* /Volumes/Data/*
do
    if [[ -h "$dir" || ! -d "$dir" ]]; then
        continue
    elif [[ "$dir" == "/Users/johnw/Music" \
         || "$dir" == "/Users/johnw/Movies" \
         || "$dir" == "/Volumes/Data/Backups" ]]; then
        continue
    fi
    cd "$dir"

    dir=$(basename "$dir")
    if ! ssh johnw@titan test -d "/data/$dir"; then
        continue
    fi

    echo ===================================================================
    echo Backing up $dir to Titan
    echo ===================================================================

    rm -f .remove.lst
    /usr/bin/find . \
        \! \( -name .Trashes -prune \) \
        \! \( -name .TemporaryItems -prune \) \
        \! -name .DS_Store \! -name .localized \
        \! -name .exclude.lst -flags hidden >> .remove.lst

     if [[ -f .exclude.lst ]]; then
         volcopy "$@" $OPTS --exclude-from=.exclude.lst \
             ./ johnw@titan:"/data/$dir/"
     else
         volcopy "$@" $OPTS \
             ./ johnw@titan:"/data/$dir/"
     fi

     if [[ -f .remove.lst ]]; then
         cat .remove.lst | while read path; do
             rm -fr "$path"
             expath=$(echo $path | sed 's/^\.//')
             echo "- $expath" >> .exclude.lst
         done
         rm -f .remove.lst
     fi

     if [[ -f .exclude.lst ]]; then
         uniqify .exclude.lst
         scp -qp .exclude.lst johnw@titan:"/data/$dir"
     fi
done

volcopy johnw@titan:/data/Photos/ /Volumes/Data/Backups/Photos/