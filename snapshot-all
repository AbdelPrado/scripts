#!/bin/bash

OPTS="-hv --ignore-errors --force-delete --exclude=.remove.lst"

volcopy "$@" $OPTS --delete --filter='-p .#*' \
    --exclude=/.screenrc --exclude=/.local/ --exclude=/.cache/ \
    --exclude='/Library/Application Support/Hazel/trash*' \
    --exclude=/Library/Caches/ \
    ~/ johnw@titan:./

for i in Archives Contracts Machines Mirrors Music \
         Packages Photos Pictures Projects
do
    echo ========================================================================
    echo Backing up /Volumes/RAID/$i to Titan
    echo ========================================================================
    cd /Volumes/RAID/$i

    rm -f .remove.lst
    find . \! \( -name .Trashes -prune \) \
           \! \( -name .TemporaryItems -prune \) \
           \! -name .DS_Store \
           \! -name .localized \
           \! -name .exclude.lst -flags hidden >> .remove.lst

     if [[ -f .exclude.lst ]]; then
         volcopy "$@" $OPTS --exclude-from=.exclude.lst \
             ./ johnw@titan:/data/$i/
     else
         volcopy "$@" $OPTS ./ johnw@titan:/data/$i/
     fi

     if [[ -f .remove.lst ]]; then
         cat .remove.lst | while read path; do
             rm -fr "$path"
             expath=$(echo $path | sed 's/^\.//')
             echo "- $expath" >> .exclude.lst
         done
         rm -f .remove.lst
     fi

     if [[ -f .exclude.lst ]]; then
         uniqify .exclude.lst
         scp -qp .exclude.lst johnw@titan:/data/$i
     fi
done
