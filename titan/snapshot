#!/bin/bash

pool=tank

case $1 in
    hourly)      label=$(date +hour_%H) ;;
    daily)       label=$(date +day_%d) ;;
    day_of_week) label=$(date +%A | tr 'A-Z' 'a-z') ;;
    weekly)      label=$(date +week_%U) ;;
    monthly)     label=$(date +%B | tr 'A-Z' 'a-z') ;;
    yearly)      label=$(date +year_%Y) ;;
esac

/sbin/zfs list -H -r -t filesystem -o name $pool | \
while read fs rest
do
    if [[ $fs != tank/Backups/CrashPlan
       && $fs != tank/Backups/CrashPlan/Vulcan
       && $fs != tank/Backups/CrashPlan/Mohajer ]]; then
        /sbin/zfs destroy $fs@${label}_new 2> /dev/null
        /sbin/zfs snapshot $fs@${label}_new
        /sbin/zfs destroy $fs@$label 2> /dev/null
        /sbin/zfs rename $fs@${label}_new $fs@$label
    fi
done
