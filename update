#!/bin/bash

if [[ "$1" == "-a" || "$1" == "--all" ]]; then
    if ! running fetchmail; then
        getmail &
    fi
fi

#
python2.7 ~/src/tools/mirror-hackage/mirror_hackage.py ~/Mirrors/Hackage

#
cabal update

if [[ "$1" == "--all" ]]; then
    cab outdated | awk '{print $1}' | grep -v Crypto | xargs cabal install -j
    for i in $(seq 0 20); do
        yes | cabal-delete $(cabal-delete -l | tail +3 | awk '{print $1}')
    done > /tmp/cabal-delete.log 2>&1
fi

ghc-pkg check

#
brew update
brew doctor

if [[ "$1" == "--all" ]]; then
    brew upgrade
fi

#
if [[ "$1" == "--all" ]]; then
    (cd ~/.cabal/share/hoogle/databases && \
     time hoogle data -r -l all) &
fi

if [[ "$1" == "-a" || "$1" == "--all" ]]; then
    git all fetch ~/Archives/ ~/Projects/ ~/Contracts/ &
fi

wait

if [[ "$1" == "--all" ]]; then
    (cd ~/.cabal/share/hoogle/databases && \
     time rehoo -j16 -c256 .)
fi

exit 0
